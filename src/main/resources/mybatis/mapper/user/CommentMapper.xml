<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vvs.platform.dao.user.CommentDAO">

    <!-- 특정 의안(billId)의 전체 댓글 조회 -->
    <select id="listAllByBillId" resultType="com.vvs.platform.dto.user.CommentDTO">
        SELECT 
            SEQ as seq,
            BILL_ID as billId,
            USER_ID as userId,
            CONTENT as content,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt,
            SIDE as side
        FROM comments
        WHERE BILL_ID = #{billId}
        ORDER BY CREATED_AT DESC
    </select>
    
    <!-- seq로 댓글 단건 조회 -->
    <select id="selectById" resultType="com.vvs.platform.dto.user.CommentDTO" parameterType="long">
        SELECT 
            SEQ as seq,
            BILL_ID as billId,
            USER_ID as userId,
            CONTENT as content,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt,
            SIDE as side
        FROM comments
        WHERE SEQ = #{seq}
    </select>
    
    <!-- 댓글 입력 -->
    <insert id="insertC" parameterType="com.vvs.platform.dto.user.CommentDTO">
        <selectKey resultType="long" keyProperty="seq" order="BEFORE">
            SELECT seq_comments.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO comments (
            SEQ, BILL_ID, USER_ID, CONTENT, CREATED_AT, SIDE
        ) VALUES (
            #{seq}, #{billId}, #{userId}, #{content}, SYSDATE, #{side}
        )
    </insert>
    
    <select id="selectLatestCommentByUser" resultType="com.vvs.platform.dto.user.CommentDTO">
    SELECT *
    FROM (
        SELECT 
            SEQ as seq,
            BILL_ID as billId,
            USER_ID as userId,
            CONTENT as content,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt,
            SIDE as side
        FROM comments
        WHERE BILL_ID = #{billId}
          AND USER_ID = #{userId}
        ORDER BY CREATED_AT DESC
    )
    WHERE ROWNUM = 1
</select>
    

</mapper>
